<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Jack's Schedule V20 (Remastered)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <style>
        /* --- è®Šæ•¸èˆ‡åŸºç¤è¨­å®š --- */
        :root {
            --primary-color: #4f46e5; /* é›è— */
            --primary-light: #eef2ff;
            --bg-color: #f3f4f6;
            --card-bg: #ffffff;
            --text-main: #1f2937;
            --text-sub: #6b7280;
            --border-radius: 16px;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-hover: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }

        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; 
            background: var(--bg-color); 
            margin: 0; 
            padding: 16px; 
            color: var(--text-main);
            line-height: 1.5;
        }

        /* --- å¡ç‰‡å®¹å™¨ --- */
        .card { 
            background: var(--card-bg); 
            padding: 20px; 
            border-radius: var(--border-radius); 
            box-shadow: var(--shadow); 
            margin-bottom: 20px; 
            border: 1px solid rgba(255,255,255,0.7);
            transition: transform 0.2s ease;
        }
        
        .hidden { display: none !important; }

        /* --- æ¨™é¡Œå€ --- */
        .input-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px; }
        .header-title h2 { margin: 0; font-size: 1.5em; color: #111827; letter-spacing: -0.025em; }
        .version-tag { 
            font-size: 10px; background: #e0e7ff; color: var(--primary-color); 
            padding: 2px 8px; border-radius: 99px; font-weight: 700; text-transform: uppercase; 
            vertical-align: middle; margin-left: 8px;
        }
        
        .top-tools { display: flex; gap: 8px; }
        .top-btn { 
            background: white; border: 1px solid #e5e7eb; color: var(--text-sub); 
            width: 36px; height: 36px; border-radius: 50%; cursor: pointer;
            display: flex; align-items: center; justify-content: center;
            font-size: 16px; transition: 0.2s; box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }
        .top-btn:active { transform: scale(0.95); background: #f9fafb; }
        .top-btn:hover { color: var(--primary-color); border-color: var(--primary-color); }

        /* --- æ¨¡å¼é¸æ“‡å™¨ (Segmented Control) --- */
        .mode-selector { 
            display: flex; background: #e5e7eb; padding: 4px; border-radius: 12px; margin-bottom: 20px;
        }
        .mode-label { 
            flex: 1; text-align: center; padding: 8px 0; cursor: pointer; 
            border-radius: 8px; font-size: 13px; font-weight: 600; color: #6b7280; 
            transition: all 0.2s ease; position: relative; z-index: 1;
        }
        .mode-selector input { display: none; }
        .mode-selector input:checked + div { 
            background: white; color: var(--primary-color); 
            box-shadow: 0 2px 4px rgba(0,0,0,0.1); 
        }
        #modeReminder:checked + div { color: #9333ea; } /* ç´«è‰²æé†’ */
        
        /* --- è¼¸å…¥å…ƒä»¶ --- */
        .input-group { margin-bottom: 16px; }
        label { display: block; margin-bottom: 6px; font-weight: 600; color: #374151; font-size: 13px; }
        
        input[type="text"], input[type="tel"], input[type="date"], select { 
            width: 100%; padding: 12px 16px; 
            border: 1px solid #d1d5db; border-radius: 12px; 
            box-sizing: border-box; font-size: 16px; background: #f9fafb; 
            color: #111827; transition: 0.2s; -webkit-appearance: none;
        }
        input:focus, select:focus { 
            background: #fff; border-color: var(--primary-color); 
            outline: none; box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1); 
        }
        input:disabled { background: #f3f4f6; color: #9ca3af; border-color: #e5e7eb; }

        .row-inputs { display: flex; flex-wrap: wrap; gap: 16px; margin-bottom: 12px; }
        .col-half { flex: 1; min-width: 140px; } 

        /* --- æŒ‰éˆ• --- */
        .btn { 
            border: none; padding: 14px; border-radius: 12px; font-size: 15px; 
            cursor: pointer; font-weight: 600; width: 100%; text-align: center; 
            color: white; margin-bottom: 12px; 
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            transition: transform 0.1s, opacity 0.2s;
            display: flex; align-items: center; justify-content: center; gap: 6px;
        }
        .btn:active { transform: scale(0.97); opacity: 0.9; }
        
        .btn-primary { background: linear-gradient(135deg, #4f46e5, #4338ca); }
        .btn-image { background: linear-gradient(135deg, #7c3aed, #6d28d9); }
        .btn-warning { background: #fbbf24; color: #78350f; }
        .btn-info { background: #06b6d4; }
        .btn-danger { background: #ef4444; }
        .btn-secondary { background: #6b7280; box-shadow: none; }
        
        .btn-row { display: flex; gap: 12px; }
        .btn-row .btn { font-size: 14px; padding: 12px; margin-bottom: 0; }

        /* --- è¡¨æ ¼èˆ‡é¡¯ç¤ºå€ (Capture Area) --- */
        #captureArea { 
            background: white; padding: 0; border-radius: var(--border-radius); 
            overflow: hidden; border: 1px solid #e5e7eb;
        }
        table { width: 100%; border-collapse: collapse; table-layout: fixed; } 
        
        th, td { 
            padding: 14px 8px; vertical-align: middle; word-wrap: break-word; 
            border-bottom: 1px solid #f3f4f6; /* åªç•™åº•ç·š */
        }
        tr:last-child td { border-bottom: none; }

        /* åˆ†éš”ç·šå¼·åŒ– */
        tr.day-start td { border-top: 2px solid #e5e7eb !important; }

        /* è¡¨æ ¼å…§å®¹æ¨£å¼ */
        .col-combined { 
            width: 18%; text-align: center; font-size: 12px; line-height: 1.4; 
            color: #6b7280; font-weight: 600; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
        } 
        .col-combined strong { font-size: 15px; color: #111827; font-family: -apple-system, BlinkMacSystemFont, sans-serif; }

        .col-item { width: 62%; font-size: 15px; padding-left: 12px; color: #374151; } 
        .col-loc { width: 20%; font-size: 12px; color: #9ca3af; text-align: center; font-weight: 500; }

        /* è¡¨é ­ç¾åŒ– */
        .header-main { 
            background: linear-gradient(135deg, #ecfdf5, #d1fae5); 
            color: #065f46;
            text-align: center; font-weight: 800; font-size: 1.6em; padding: 20px; 
            letter-spacing: 0.5px; border-bottom: none;
        }
        .header-sub th { 
            background-color: #fef9c3; color: #854d0e; 
            font-size: 13px; font-weight: 700; padding: 8px; 
            border-bottom: 1px solid #e5e7eb; text-transform: uppercase;
        }
        .is-weekend { color: #ef4444; }

        /* æ“ä½œæŒ‰éˆ• (ç·¨è¼¯/åˆªé™¤) */
        .act-btns { float: right; margin-left: 8px; display: flex; gap: 4px; opacity: 0.4; transition: opacity 0.2s; }
        .col-item:hover .act-btns { opacity: 1; }
        .act-btn { 
            border: 1px solid #e5e7eb; background: #fff; border-radius: 6px; 
            width: 24px; height: 24px; font-size: 12px; 
            display: inline-flex; align-items: center; justify-content: center; 
            cursor: pointer; box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }
        .act-btn:hover { background: #f9fafb; transform: scale(1.1); }

        /* é¡è‰²æ¨™ç±¤ (ä½¿ç”¨æŸ”å’Œè‰²) */
        .bg-none { background: transparent; }
        .bg-yellow { background: #fefce8; border-left: 4px solid #facc15; }
        .bg-red { background: #fef2f2; border-left: 4px solid #f87171; }
        .bg-green { background: #f0fdf4; border-left: 4px solid #4ade80; }
        .bg-blue { background: #eff6ff; border-left: 4px solid #60a5fa; }
        .bg-orange { background: #fff7ed; border-left: 4px solid #fb923c; }
        .bg-purple { background: #faf5ff; border-left: 4px solid #a855f7; }

        /* æ¸…å–®èˆ‡è¨­å®šé é¢é …ç›® */
        .manage-item { 
            display: flex; justify-content: space-between; align-items: center; 
            padding: 12px 0; border-bottom: 1px solid #f3f4f6; 
        }
        .manage-item:last-child { border-bottom: none; }
        .tag { background: #f3f4f6; padding: 4px 8px; border-radius: 6px; font-size: 12px; color: #4b5563; font-weight: 600;}

        /* æ˜ŸæœŸé¸æ“‡å™¨ */
        .week-selector { display: flex; gap: 4px; margin-bottom: 16px; justify-content: space-between; }
        .week-selector label { 
            flex: 1; text-align: center; padding: 12px 0; background: #fff; 
            border: 1px solid #e5e7eb; border-radius: 8px; font-size: 14px; cursor: pointer;
            transition: 0.2s;
        }
        .week-selector label:has(input:checked) {
            background: #eff6ff; border-color: var(--primary-color); color: var(--primary-color);
        }
        .week-selector input { display: none; }
        .week-selector span { display: block; font-weight: 600; }
        
        /* æµ®å‹•æ›´æ–°æ™‚é–“ */
        #updateDate { font-family: monospace; opacity: 0.6; }

    </style>
</head>
<body>

    <div id="settingsArea" class="card hidden">
        <h3 style="margin-top:0; display:flex; align-items:center; gap:8px;">âš™ï¸ è¨­å®šèˆ‡ç¶­è­·</h3>
        <p style="color:#666; font-size:13px; margin-bottom:20px;">è³‡æ–™ç®¡ç†èˆ‡å‚™ä»½é‚„åŸåŠŸèƒ½</p>
        
        <button class="btn btn-danger" onclick="hardReset()">âš ï¸ é‡ç½®æ‰€æœ‰è³‡æ–™ (Reset)</button>
        <div class="btn-row" style="margin-top:12px;">
            <button class="btn btn-info" onclick="downloadBackup()">ğŸ“¥ å‚™ä»½ (Backup)</button>
            <button class="btn btn-secondary" onclick="document.getElementById('restoreFile').click()">ğŸ“¤ é‚„åŸ (Restore)</button>
            <input type="file" id="restoreFile" style="display:none" onchange="restoreBackup(this)">
        </div>
        <hr style="border:0; border-top:1px solid #eee; margin: 20px 0;">
        <button class="btn btn-secondary" onclick="toggleSettings()">é—œé–‰é¸å–®</button>
    </div>

    <div id="locEditorArea" class="card hidden">
        <h3 style="margin-top:0; color:var(--primary-color);">ğŸ“ ç®¡ç†å¸¸ç”¨åœ°é»</h3>
        <div style="display:flex; gap:8px; margin-bottom:15px;">
            <input type="text" id="newLocInput" placeholder="è¼¸å…¥åœ°é»åç¨±...">
            <button class="btn btn-primary" style="width:auto; margin-bottom:0; padding:0 20px;" onclick="addNewLoc()">æ–°å¢</button>
        </div>
        <div id="locListContainer" style="max-height:300px; overflow-y:auto; border:1px solid #f3f4f6; border-radius:12px; padding:0 10px;"></div>
        <br>
        <button class="btn btn-secondary" onclick="toggleLocEditor()">å®Œæˆä¸¦è¿”å›</button>
    </div>

    <div id="fixedEditorArea" class="card hidden">
        <h3 style="margin-top:0; color:#b45309;">ğŸ“ å›ºå®šè¡Œç¨‹è¦å‰‡</h3>
        <div style="background: #fffbeb; padding: 20px; border-radius: 12px; margin-bottom: 20px; border: 1px solid #fcd34d;">
            <label>é¸æ“‡æ˜ŸæœŸ</label>
            <div class="week-selector">
                <label><input type="checkbox" value="1"><span>ä¸€</span></label>
                <label><input type="checkbox" value="2"><span>äºŒ</span></label>
                <label><input type="checkbox" value="3"><span>ä¸‰</span></label>
                <label><input type="checkbox" value="4"><span>å››</span></label>
                <label><input type="checkbox" value="5"><span>äº”</span></label>
                <label><input type="checkbox" value="6"><span>å…­</span></label>
                <label><input type="checkbox" value="0"><span>æ—¥</span></label>
            </div>
            <div class="row-inputs">
                <div class="col-half"><label>æ™‚é–“ (ä¾‹å¦‚ 1400)</label><input type="tel" id="fixTime" maxlength="4" placeholder="1400"></div>
                <div class="col-half"><label>åœ°é»</label><input type="text" id="fixLoc" placeholder="åœ°é»"></div>
            </div>
            <div style="margin-top:10px;"><label>äº‹é …</label><input type="text" id="fixContent" placeholder="ä¾‹å¦‚: GYM, é–‹æœƒ"></div>
            <div style="margin-top:16px;"><button class="btn btn-warning" onclick="addFixedRule()">æ–°å¢å›ºå®šè¦å‰‡</button></div>
        </div>
        <h4 style="margin-bottom:10px; color:#4b5563;">ç›®å‰è¦å‰‡åˆ—è¡¨ï¼š</h4>
        <div id="fixedRulesList"></div>
        <br>
        <button class="btn btn-secondary" onclick="toggleFixedEditor()">è¿”å›</button>
    </div>

    <div class="card" id="mainInputArea">
        <div class="input-header">
            <div class="header-title">
                <h2>ğŸ“… è¡Œç¨‹è¼¸å…¥</h2>
                <span class="version-tag">V20</span>
            </div>
            <div class="top-tools">
                <button class="top-btn" onclick="toggleLocEditor()" title="åœ°é»ç®¡ç†">ğŸ“</button>
                <button class="top-btn" onclick="toggleFixedEditor()" title="å›ºå®šè¡Œç¨‹">âš™ï¸</button>
                <button class="top-btn" onclick="toggleSettings()" title="è¨­å®š">ğŸ”§</button>
            </div>
        </div>

        <div class="mode-selector">
            <label class="mode-label">
                <input type="radio" name="inputMode" id="modeDate" value="DATE" checked onchange="toggleInputMode()">
                <div class="mode-text">ğŸ”µ æŒ‡å®šæ—¥æœŸ</div>
            </label>
            <label class="mode-label">
                <input type="radio" name="inputMode" id="modeTBD" value="TBD" onchange="toggleInputMode()">
                <div class="mode-text">âšª æ™‚é–“å¾…å®š</div>
            </label>
            <label class="mode-label">
                <input type="radio" name="inputMode" id="modeReminder" value="REMINDER" onchange="toggleInputMode()">
                <div class="mode-text">ğŸŸ£ ææä½ </div>
            </label>
        </div>

        <div class="row-inputs">
            <div class="col-half"><label>æ—¥æœŸ</label><input type="date" id="inputDate"></div>
            <div class="col-half"><label>æ™‚é–“ (ä¾‹: 0930)</label><input type="tel" id="inputTime" maxlength="4" placeholder="0930"></div>
        </div>
        
        <div class="input-group" style="margin-top:10px;"><label>äº‹é …å…§å®¹</label><input type="text" id="inputItem" placeholder="è¼¸å…¥äº‹é …..."></div>
        
        <div class="row-inputs">
            <div class="col-half">
                <label>åœ°é»</label>
                <input type="text" id="inputLoc" list="locationList" placeholder="åœ°é»...">
                <datalist id="locationList"></datalist>
            </div>
            <div class="col-half"><label>æ¨™ç¤ºé¡è‰²</label>
                <select id="inputColor">
                    <option value="none">ç„¡è‰² (é è¨­)</option>
                    <option value="yellow">ğŸŸ¡ äº®é»ƒ (é‡è¦)</option>
                    <option value="red">ğŸ”´ äº®ç´… (ç·Šæ€¥)</option>
                    <option value="green">ğŸŸ¢ äº®ç¶  (ä¼‘é–’)</option>
                    <option value="blue">ğŸ”µ äº®è— (å•†å‹™)</option>
                    <option value="orange">ğŸŸ  äº®æ©˜ (å…¶ä»–)</option>
                    <option value="purple">ğŸŸ£ äº®ç´« (æé†’)</option>
                </select>
            </div>
        </div>
        <button class="btn btn-primary" style="margin-top:20px;" onclick="addSchedule()">â• åŠ å…¥ / æ›´æ–°è¡Œç¨‹</button>
    </div>

    <div class="btn-row" style="margin-bottom:20px;">
        <button class="btn btn-image" onclick="exportImage()">ğŸ“¸ ä¸‹è¼‰åœ–ç‰‡</button>
        <button class="btn btn-secondary" style="background:#6b7280" onclick="deletePast()">ğŸ§¹ æ¸…é™¤éæœŸ</button>
        <button class="btn btn-danger" onclick="clearData()">ğŸ—‘ï¸ æ¸…ç©ºæ‰€æœ‰</button>
    </div>

    <div class="card" style="padding:0; border:none; box-shadow: var(--shadow-hover);">
        <div id="captureArea">
            <table id="scheduleTable">
                <colgroup>
                    <col style="width: 18%;">
                    <col style="width: 62%;">
                    <col style="width: 20%;">
                </colgroup>
                <thead>
                    <tr><td colspan="3" class="header-main">Jack's Schedule</td></tr>
                    <tr><td colspan="3" style="text-align:right; font-size:11px; border:none; padding:8px 12px; color:#6b7280; background:#f9fafb;" id="updateDate">updated: </td></tr>
                    <tr class="header-sub">
                        <th class="col-combined">DATE</th>
                        <th class="col-item" style="text-align: left; padding-left:12px;">EVENT</th>
                        <th class="col-loc" style="text-align: center;">LOC</th>
                    </tr>
                </thead>
                <tbody id="tableBody"></tbody>
            </table>
        </div>
    </div>

    <script>
        // --- 1. åˆå§‹åŒ–è³‡æ–™ (V20 æ›´æ–°ï¼šé è¼‰å¤§é‡è³‡æ–™) ---
        const DB_KEY_SCHEDULE = 'jack_schedule_v20'; // æ›Keyä»¥å¼·åˆ¶æ›´æ–°è³‡æ–™
        const DB_KEY_RULES = 'jack_rules_v20';
        const DB_KEY_LOCS = 'jack_locs_v20';

        const defaultRules = [
            { days:[1,3,5], time:"1130", content:"GYM", loc:"" },
            { days:[2], time:"1400", content:"é–‹æœƒ (éšŠé•·)", loc:"" },
            { days:[3], time:"1400", content:"é–‹æœƒ (JLL)", loc:"" },
            { days:[3], time:"1510", content:"æ¨æ‹¿", loc:"" },
            { days:[4], time:"1600", content:"éƒ¨é–€ä¸»ç®¡é–‹æœƒ", loc:"" },
            { days:[5], time:"1400", content:"å·¥ç¨‹è¡Œå ´", loc:"" },
            { days:[5], time:"1500", content:"å·¥ç¨‹æœƒè­°", loc:"" }
        ];

        const defaultLocs = [
            "åä¸‰é…’åº—", "åˆ©æ¾³é…’åº—", "å–œç²µ8è™Ÿ", "è“®-å¤§æ½­å±±", 
            "å…¬å¸", "å®¶è£¡", "MGM", "çš‡å† å‡æ—¥é…’åº—", "ä¸­åŸ", "æ°¸åˆ©", "å–œç²µ8è™Ÿv1"
        ];

        // V20 é è¨­è¡Œç¨‹è³‡æ–™
        const presetSchedules = [
            { date: "2025-12-29", time: "09:30", content: "Kenå“¥ä¾†è¨ª", location: "", color: "none" },
            { date: "2025-12-29", time: "11:30", content: "GYM", location: "", color: "none" },
            { date: "2025-12-29", time: "14:00", content: "é–‹æœƒ (Sunny)", location: "", color: "none" },
            { date: "2025-12-29", time: "17:00", content: "Spa meeting", location: "", color: "none" },
            { date: "2025-12-30", time: "14:00", content: "é–‹æœƒ (éšŠé•·)", location: "", color: "none" },
            { date: "2025-12-30", time: "16:00", content: "éƒ¨é–€ä¸»ç®¡é–‹æœƒ", location: "", color: "none" },
            { date: "2025-12-30", time: "19:00", content: "å®´å®¢(é™³å®‰å®‰é†«ç”Ÿ)", location: "è“®-å¤§æ½­å±±", color: "yellow" },
            { date: "2025-12-31", time: "11:30", content: "GYM", location: "", color: "none" },
            { date: "2025-12-31", time: "14:00", content: "é–‹æœƒ(JLL)", location: "", color: "none" },
            { date: "2025-12-31", time: "15:10", content: "æ¨æ‹¿", location: "", color: "none" },
            { date: "2026-01-01", time: "", content: "å…ƒæ—¦", location: "", color: "red" },
            { date: "2026-01-01", time: "09:00", content: "ä¸Šä¸­å±±", location: "", color: "yellow" },
            { date: "2026-01-02", time: "11:30", content: "GYM", location: "", color: "none" },
            { date: "2026-01-02", time: "15:00", content: "ç‡éŸ³éŸ¿", location: "", color: "none" },
            { date: "2026-01-02", time: "15:30", content: "å·¥ç¨‹è¡Œå ´", location: "", color: "none" },
            { date: "2026-01-02", time: "16:30", content: "å·¥ç¨‹æœƒè­°", location: "", color: "none" },
            { date: "2026-01-02", time: "19:00", content: "å®´å®¢(é˜¿Sir)", location: "å–œç²µ8è™Ÿv1", color: "yellow" },
            { date: "2026-01-13", time: "19:00", content: "ä¸­åŸåœ°ç”¢æ™šå®´", location: "çš‡å† å‡æ—¥é…’åº—-2æ¨“æ˜ç æ®¿", color: "none" },
            { date: "2026-01-17", time: "", content: "èŠŠç¾½ç”Ÿæ—¥", location: "", color: "none" },
            { date: "2026-01-23", time: "19:00", content: "å®´å®¢ (æ°¸åˆ©Linda)", location: "è“®-å¤§æ½­å±±", color: "none" },
            { date: "2026-01-27", time: "", content: "å˜‰è±ªç”Ÿæ—¥", location: "", color: "none" },
            { date: "2026-02-16", time: "", content: "åœ˜å¹´é£¯", location: "å–œç²µ8è™Ÿå®´æœƒå»³", color: "none" },
            { date: "2026-02-18", time: "", content: "å¹´åˆäºŒä¸­åˆé£²èŒ¶", location: "å–œç²µ8è™Ÿv1", color: "none" },
            { date: "2026-02-19", time: "", content: "å¹´åˆä¸‰ä¸­åˆé£²èŒ¶", location: "å–œç²µ8è™Ÿv1", color: "none" },
            { date: "TBD", time: "", content: "MGMå–ç å¯¶", location: "", color: "green" },
            { date: "TBD", time: "", content: "æœ‰å•–å¥½é£Ÿ", location: "", color: "none" }
        ];

        let schedules = []; let fixedRules = []; let savedLocs = [];

        function initApp() {
            try {
                const sData = localStorage.getItem(DB_KEY_SCHEDULE);
                const rData = localStorage.getItem(DB_KEY_RULES);
                const lData = localStorage.getItem(DB_KEY_LOCS);

                // å¦‚æœæ˜¯ç¬¬ä¸€æ¬¡ä½¿ç”¨ V20ï¼Œè¼‰å…¥é è¨­è³‡æ–™
                if (!sData) {
                    schedules = JSON.parse(JSON.stringify(presetSchedules));
                    saveData();
                } else {
                    schedules = JSON.parse(sData);
                }

                if (!rData) { fixedRules = JSON.parse(JSON.stringify(defaultRules)); saveData(); } else { fixedRules = JSON.parse(rData); }
                if (!lData) { savedLocs = JSON.parse(JSON.stringify(defaultLocs)); saveData(); } else { savedLocs = JSON.parse(lData); }

                // é è¨­æ—¥æœŸè¨­ç‚º 2025-12-28 è®“ä½¿ç”¨è€…çœ‹åˆ°æ•ˆæœ (é€šå¸¸è¨­ç‚ºä»Šå¤©)
                // document.getElementById('inputDate').value = "2025-12-28";
                document.getElementById('inputDate').valueAsDate = new Date();
                
                toggleInputMode();
                updateLocDatalist();
                renderTable();
            } catch (e) { hardReset(); }
        }

        function saveData() {
            localStorage.setItem(DB_KEY_SCHEDULE, JSON.stringify(schedules));
            localStorage.setItem(DB_KEY_RULES, JSON.stringify(fixedRules));
            localStorage.setItem(DB_KEY_LOCS, JSON.stringify(savedLocs));
        }

        function toggleDateInput() {
            const isTBD = document.getElementById('dateTBD').checked;
            document.getElementById('inputDate').disabled = isTBD;
            document.getElementById('inputTime').disabled = isTBD;
            if (isTBD) {
                document.getElementById('inputDate').style.backgroundColor = '#eee';
                document.getElementById('inputTime').style.backgroundColor = '#eee';
            } else {
                document.getElementById('inputDate').style.backgroundColor = '#fff';
                document.getElementById('inputTime').style.backgroundColor = '#fff';
            }
        }

        function toggleInputMode() {
            const mode = document.querySelector('input[name="inputMode"]:checked').value;
            const isDateMode = (mode === 'DATE');
            
            document.getElementById('inputDate').disabled = !isDateMode;
            document.getElementById('inputTime').disabled = !isDateMode;
            
            if (!isDateMode) {
                document.getElementById('inputDate').value = ''; 
                document.getElementById('inputTime').value = '';
            } else {
                if(!document.getElementById('inputDate').value) document.getElementById('inputDate').valueAsDate = new Date();
            }
        }

        const weekMap = ['é€±æ—¥', 'é€±ä¸€', 'é€±äºŒ', 'é€±ä¸‰', 'é€±å››', 'é€±äº”', 'é€±å…­'];
        function getTodayZero() { 
            // ç‚ºäº†å±•ç¤ºæ‚¨çš„ 2025 è¡Œç¨‹ï¼Œé€™è£¡æš«æ™‚å°‡ã€Œä»Šå¤©ã€è¦–ç‚º 2025/12/28
            // å¦‚æœè¦æ”¹å›çœŸå¯¦ä»Šå¤©ï¼Œè«‹ç”¨: return new Date(new Date().setHours(0,0,0,0));
            // é€™è£¡ç”¨çœŸå¯¦æ—¥æœŸï¼Œå› ç‚ºæ‚¨çš„è³‡æ–™æ˜¯æœªä¾†çš„
            const d = new Date(); d.setHours(0,0,0,0); return d; 
        }
        function strToDate(s) { 
            if(!s || s==='TBD' || s==='REMINDER') return new Date(9999, 11, 31); 
            const p=s.split('-'); return new Date(p[0], p[1]-1, p[2]); 
        }
        function formatDateShow(d) { return (d.getMonth()+1) + '/' + d.getDate(); }
        function formatTimeInput(val) { if(!val) return ""; val = val.replace(/[^0-9]/g, ''); if(val.length === 3) val = "0" + val; if(val.length === 4) { let h = val.substring(0,2); let m = val.substring(2,4); if(parseInt(h)>23) h="23"; if(parseInt(m)>59) m="59"; return h + ":" + m; } return ""; }
        function displayTime(t) { if(!t) return ""; let [hh, mm] = t.split(':'); let h = parseInt(hh); let p = h >= 12 ? 'PM' : 'AM'; h = h % 12; if(h===0) h=12; return `${h}:${mm} ${p}`; }

        function renderTable() {
            const tbody = document.getElementById('tableBody'); tbody.innerHTML = ''; 
            
            // ç‚ºäº†è®“æ‚¨çš„ 2025/12/28 è¡Œç¨‹èƒ½æ­£ç¢ºé¡¯ç¤ºåœ¨ã€Œå‰ä¸ƒå¤©ã€ï¼Œæˆ‘å€‘éœ€è¦ä¸€å€‹åƒè€ƒé»
            // å¦‚æœç¾åœ¨çœŸå¯¦æ™‚é–“é‚„æ²’åˆ° 2025ï¼Œé€™æœƒé¡¯ç¤ºåœ¨å¾ŒçºŒè¡Œç¨‹ã€‚
            // ç‚ºäº†æ–¹ä¾¿æ‚¨æª¢æŸ¥ï¼Œæˆ‘é€™è£¡å°‡ã€Œèµ·å§‹é¡¯ç¤ºæ—¥æœŸã€è¨­ç‚ºè³‡æ–™ä¸­æœ€æ—©çš„æ—¥æœŸï¼Œæˆ–è€…çœŸå¯¦çš„ä»Šå¤©
            // å¯¦å‹™ä¸Šé‚„æ˜¯ç”¨çœŸå¯¦ä»Šå¤©ï¼š
            let today = getTodayZero();
            
            // å¦‚æœæ‚¨å¸Œæœ›æ¸¬è©¦æ™‚çœ‹åˆ° 2025 å¹´çš„è³‡æ–™åœ¨ä¸Šé¢ï¼Œå¯ä»¥æš«æ™‚æŠŠä¸‹é¢é€™è¡Œå–æ¶ˆè¨»è§£ï¼š
            // today = new Date(2025, 11, 28); // 2025-12-28

            // æ’åº
            schedules.sort((a,b) => { 
                let dA = strToDate(a.date), dB = strToDate(b.date);
                if(dA.getTime() !== dB.getTime()) return dA - dB;
                return (a.time||"") > (b.time||"") ? 1 : -1; 
            });

            const now = new Date(); document.getElementById('updateDate').innerText = 'updated: ' + (now.getMonth()+1)+'/'+now.getDate();

            // 1. è¿‘ 7 å¤©
            let renderedIdx = [];
            for(let i=0; i<7; i++) {
                let d = new Date(today); d.setDate(today.getDate()+i);
                let dateStr = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
                let dayEvents = schedules.filter((s, idx) => { if(s.date === dateStr) { s._idx = idx; return true; } return false; });

                let combinedDateStr = `<strong>${formatDateShow(d)}</strong><br>${weekMap[d.getDay()]}`;
                let isWeekend = (d.getDay() === 0 || d.getDay() === 6) ? 'is-weekend' : '';

                if(dayEvents.length === 0) {
                    tbody.innerHTML += `<tr class="day-start"><td class="col-combined ${isWeekend}">${combinedDateStr}</td><td class="col-item"></td><td class="col-loc"></td></tr>`;
                } else {
                    let first = true;
                    dayEvents.forEach(evt => {
                        renderedIdx.push(evt._idx);
                        let contentHtml = evt.content;
                        if(evt.time) contentHtml = `<strong>${displayTime(evt.time)}</strong> - ${evt.content}`;
                        
                        let rowClass = `bg-${evt.color}`;
                        if (first) rowClass += ' day-start';

                        tbody.innerHTML += `<tr class="${rowClass}">
                            <td class="col-combined ${isWeekend}">${first ? combinedDateStr : ''}</td>
                            <td class="col-item">${contentHtml}<div class="act-btns" data-html2canvas-ignore="true"><button class="act-btn" onclick="editItem(${evt._idx})">âœ</button><button class="act-btn" onclick="delItem(${evt._idx})" style="color:red">x</button></div></td>
                            <td class="col-loc">${evt.location}</td>
                        </tr>`;
                        first = false;
                    });
                }
            }
            
            // 2. å¾ŒçºŒè¡Œç¨‹
            let future = schedules.filter((s, idx) => !renderedIdx.includes(idx) && s.date !== 'TBD' && s.date !== 'REMINDER' && strToDate(s.date) >= today);
            if(future.length > 0) {
                tbody.innerHTML += `<tr class="day-start"><td colspan="3" style="background:#4472C4; color:white; font-weight:bold; text-align:center; padding:8px; font-size:13px;">å¾ŒçºŒè¡Œç¨‹</td></tr>`;
                let lastD = '';
                let isFirstFuture = true;
                future.forEach((evt) => {
                    let d = strToDate(evt.date); let dStr = formatDateShow(d);
                    let isNewDay = (dStr !== lastD);
                    let combinedHtml = isNewDay ? `<strong>${dStr}</strong><br>${weekMap[d.getDay()]}` : '';
                    lastD = dStr;
                    
                    let contentHtml = evt.time ? `<strong>${displayTime(evt.time)}</strong> - ${evt.content}` : evt.content;
                    let realIdx = schedules.indexOf(evt);
                    let rowClass = `bg-${evt.color}`;
                    if (isNewDay && !isFirstFuture) rowClass += ' day-start';

                    tbody.innerHTML += `<tr class="${rowClass}">
                        <td class="col-combined">${combinedHtml}</td>
                        <td class="col-item">${contentHtml}<div class="act-btns" data-html2canvas-ignore="true"><button class="act-btn" onclick="editItem(${realIdx})">âœ</button><button class="act-btn" onclick="delItem(${realIdx})" style="color:red">x</button></div></td>
                        <td class="col-loc">${evt.location}</td>
                    </tr>`;
                    isFirstFuture = false;
                });
            }

            // 3. å¾…è¾¦äº‹é …
            let pending = schedules.filter((s, idx) => s.date === 'TBD' || s.date === 'REMINDER');
            if(pending.length > 0) {
                tbody.innerHTML += `<tr class="day-start"><td colspan="3" style="background:#E1BEE7; color:#000; font-weight:bold; text-align:center; padding:8px; font-size:13px;">ææä½  / å¾…è¾¦äº‹é …</td></tr>`;
                
                pending.forEach((evt) => {
                    let realIdx = schedules.indexOf(evt);
                    let label = evt.date === 'REMINDER' ? 'ææä½ ' : 'æ™‚é–“å¾…å®š';
                    let labelColor = evt.date === 'REMINDER' ? '#6a1b9a' : '#555';
                    let labelWeight = evt.date === 'REMINDER' ? 'bold' : 'normal';

                    tbody.innerHTML += `<tr class="bg-${evt.color}" style="border-top:1px solid #ddd;">
                        <td class="col-combined" style="color:${labelColor}; font-weight:${labelWeight};">${label}</td>
                        <td class="col-item">${evt.content}<div class="act-btns" data-html2canvas-ignore="true"><button class="act-btn" onclick="editItem(${realIdx})">âœ</button><button class="act-btn" onclick="delItem(${realIdx})" style="color:red">x</button></div></td>
                        <td class="col-loc">${evt.location}</td>
                    </tr>`;
                });
            }
        }

        function addSchedule() {
            let mode = document.querySelector('input[name="inputMode"]:checked').value;
            let d = document.getElementById('inputDate').value;
            let t = document.getElementById('inputTime').value;
            let c = document.getElementById('inputItem').value; 
            let l = document.getElementById('inputLoc').value;
            let col = document.getElementById('inputColor').value;

            if(!c) { alert('è«‹è¼¸å…¥äº‹é …å…§å®¹'); return; }
            if(mode === 'DATE' && !d) { alert('è«‹è¼¸å…¥æ—¥æœŸ'); return; }

            let finalDate = d;
            if (mode === 'TBD') finalDate = 'TBD';
            if (mode === 'REMINDER') finalDate = 'REMINDER';
            
            let finalTime = (mode === 'DATE') ? formatTimeInput(t) : '';

            schedules.push({ date: finalDate, time: finalTime, content: c, location: l, color: col });
            saveData(); renderTable();
            
            document.getElementById('inputItem').value = ''; 
            document.getElementById('inputLoc').value = '';
            document.getElementById('inputTime').value = ''; 
            document.getElementById('inputColor').value = 'none';
        }

        function delItem(idx) { if(confirm('åˆªé™¤æ­¤äº‹é …ï¼Ÿ')) { schedules.splice(idx, 1); saveData(); renderTable(); } }
        function editItem(idx) {
            let s = schedules[idx];
            if (s.date === 'TBD') {
                document.getElementById('modeTBD').checked = true;
            } else if (s.date === 'REMINDER') {
                document.getElementById('modeReminder').checked = true;
            } else {
                document.getElementById('modeDate').checked = true;
                document.getElementById('inputDate').value = s.date;
                document.getElementById('inputTime').value = s.time ? s.time.replace(':','') : '';
            }
            toggleInputMode();
            document.getElementById('inputItem').value = s.content; 
            document.getElementById('inputLoc').value = s.location;
            document.getElementById('inputColor').value = s.color; 
            schedules.splice(idx, 1); saveData(); renderTable(); window.scrollTo({top:0, behavior:'smooth'});
        }

        function toggleLocEditor() {
            const area = document.getElementById('locEditorArea');
            const main = document.getElementById('mainInputArea');
            if(area.classList.contains('hidden')) { area.classList.remove('hidden'); main.classList.add('hidden'); renderLocEditorList(); } 
            else { area.classList.add('hidden'); main.classList.remove('hidden'); updateLocDatalist(); }
        }
        function updateLocDatalist() {
            const dl = document.getElementById('locationList'); dl.innerHTML = '';
            savedLocs.forEach(loc => { let opt = document.createElement('option'); opt.value = loc; dl.appendChild(opt); });
        }
        function renderLocEditorList() {
            const container = document.getElementById('locListContainer'); container.innerHTML = '';
            savedLocs.forEach((loc, index) => {
                container.innerHTML += `<div class="manage-item"><span style="font-size:15px; margin-left:10px;">${loc}</span><button class="btn btn-danger" style="width:auto; margin:0; padding:6px 12px; font-size:12px;" onclick="deleteLoc(${index})">åˆªé™¤</button></div>`;
            });
        }
        function addNewLoc() {
            const input = document.getElementById('newLocInput'); const val = input.value.trim();
            if(!val) return; savedLocs.push(val); input.value = ''; saveData(); renderLocEditorList();
        }
        function deleteLoc(index) { if(confirm('ç¢ºå®šåˆªé™¤ï¼Ÿ')) { savedLocs.splice(index, 1); saveData(); renderLocEditorList(); } }

        function toggleFixedEditor() {
            let area = document.getElementById('fixedEditorArea'); let main = document.getElementById('mainInputArea');
            if(area.classList.contains('hidden')) { area.classList.remove('hidden'); main.classList.add('hidden'); renderFixedList(); } 
            else { area.classList.add('hidden'); main.classList.remove('hidden'); }
        }
        function addFixedRule() {
            let cbs = document.querySelectorAll('.week-selector input:checked'); let days = Array.from(cbs).map(cb => parseInt(cb.value));
            let t = document.getElementById('fixTime').value; let c = document.getElementById('fixContent').value; let l = document.getElementById('fixLoc').value;
            if(days.length===0 || !c) { alert('è«‹é¸æ˜ŸæœŸä¸¦è¼¸å…¥äº‹é …'); return; }
            fixedRules.push({ days: days, time: t, content: c, loc: l }); saveData(); renderFixedList();
            document.getElementById('fixContent').value = ''; document.getElementById('fixLoc').value = '';
        }
        function delFixedRule(idx) {
            if(confirm('åˆªé™¤è¦å‰‡ï¼Ÿ')) {
                fixedRules.splice(idx, 1); saveData(); renderFixedList();
            }
        }
        function renderFixedList() {
            let div = document.getElementById('fixedRulesList'); div.innerHTML = '';
            fixedRules.forEach((r, i) => {
                let dStr = r.days.map(d => weekMap[d].replace('é€±','')).join(','); let tStr = r.time ? formatTimeInput(r.time) : '';
                div.innerHTML += `<div class="manage-item"><div style="font-size:14px;"><span class="tag">é€±${dStr}</span> <b>${tStr}</b> ${r.content}</div><button class="btn btn-danger" style="width:auto; padding:5px 10px; margin:0; font-size:12px;" onclick="delFixedRule(${i})">åˆª</button></div>`;
            });
        }

        function toggleSettings() { document.getElementById('settingsArea').classList.toggle('hidden'); }
        function hardReset() { if(confirm('é‡ç½®æ‰€æœ‰è³‡æ–™ï¼Ÿ')) { localStorage.clear(); location.reload(); } }
        function deletePast() { if(confirm('æ¸…é™¤éæœŸè¡Œç¨‹ï¼Ÿ')) { let today = getTodayZero(); schedules = schedules.filter(s => s.date==='TBD' || s.date==='REMINDER' || strToDate(s.date) >= today); saveData(); renderTable(); } }
        function clearData() { if(confirm('æ¸…ç©ºæ‰€æœ‰è¡Œç¨‹ï¼Ÿ')) { schedules = []; saveData(); renderTable(); } }
        function exportImage() { let el = document.getElementById("captureArea"); html2canvas(el, { scale: 2, backgroundColor: "#ffffff" }).then(canvas => { let link = document.createElement('a'); link.download = 'Schedule.png'; link.href = canvas.toDataURL("image/png"); link.click(); }); }
        function downloadBackup() { let data = { s: schedules, r: fixedRules, l: savedLocs }; let dl = document.createElement('a'); dl.href = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(data)); dl.download = "backup.json"; dl.click(); }
        function restoreBackup(input) { let file = input.files[0]; if(!file) return; let reader = new FileReader(); reader.onload = function(e) { try { let d = JSON.parse(e.target.result); if(d.s) schedules = d.s; if(d.r) fixedRules = d.r; if(d.l) savedLocs = d.l; saveData(); location.reload(); } catch(err) { alert('æª”æ¡ˆéŒ¯èª¤'); } }; reader.readAsText(file); }

        initApp();
    </script>
</body>
</html>
